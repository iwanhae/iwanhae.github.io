<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="구 블로그에서 가져옴"><title>Netplan Bridge 구성기</title><link rel=canonical href=https://iwanhae.github.io/p/config-netplan-bridge/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Netplan Bridge 구성기"><meta property="og:description" content="구 블로그에서 가져옴"><meta property="og:url" content="https://iwanhae.github.io/p/config-netplan-bridge/"><meta property="og:site_name" content="iWan"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2019-05-28T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-28T00:00:00+00:00"><meta property="og:image" content="https://iwanhae.github.io/p/config-netplan-bridge/netplan.png"><meta name=twitter:title content="Netplan Bridge 구성기"><meta name=twitter:description content="구 블로그에서 가져옴"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://iwanhae.github.io/p/config-netplan-bridge/netplan.png"></head><body><div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_hub2a4b6b69d3b0618960cb9af6c0975e0_643282_300x300_resize_box_2.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>😎️</span></figure><h1 class=site-name><a href=https://iwanhae.github.io>iWan</a></h1><h2 class=site-description>#include "Hi.h"</h2></header><ol class=menu id=main-menu><li><a href=https://iwanhae.github.io/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=https://iwanhae.github.io/welcome-to-iwan><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=https://iwanhae.github.io/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://iwanhae.github.io class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class="has-image main-article"><header class=article-header><div class=article-image><img srcset="/p/config-netplan-bridge/netplan_hu64e3fbf4fa724c9fadaeb8a9cb4d85df_56060_1024x0_resize_box_2.png 1024w, /p/config-netplan-bridge/netplan_hu64e3fbf4fa724c9fadaeb8a9cb4d85df_56060_2000x0_resize_box_2.png 2000w" src=/p/config-netplan-bridge/netplan_hu64e3fbf4fa724c9fadaeb8a9cb4d85df_56060_2000x0_resize_box_2.png width=1200 height=275 loading=lazy alt="Featured image of post Netplan Bridge 구성기"></div><div class=article-details><header class=article-category><a href=https://iwanhae.github.io/categories/server/ class=color-tag data-image=/p/config-netplan-bridge/netplan_hu64e3fbf4fa724c9fadaeb8a9cb4d85df_56060_20x20_fill_box_smart1_2.png data-key=config-netplan-bridge data-hash="md5-ABxmSxxb4eJwr+EYPCBD0w==">Server</a></header><h2 class=article-title><a href=https://iwanhae.github.io/p/config-netplan-bridge/>Netplan Bridge 구성기</a></h2><h3 class=article-subtitle>구 블로그에서 가져옴</h3><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>2019년 05월 28일</time></footer></div></header><section class=article-content><h2 id=서론>서론</h2><p>우분투가 <code>netplan</code>을 사용한지는 꽤 된걸로 알고있다. <code>17.04</code> 부터 였던가? 아마 그쯤이었던걸로 기억한다. 그냥 알던데로 ifup, ifdown 명령어를 쓰거나 /etc/network에 들어가서 네트워크 설정을 분명 수정했는데 제대로 반영이 안되서 멘붕왔던게 지금도 기억난다. ㅋㅋㅋ&mldr;..ㅠ</p><p>뭐 그건 그때고, <code>netplan</code>을 한번 알고나니깐 이렇게 직관적이고 간편한것도 없다는게 지금생각이다. 덕분에 <code>CentOS</code>쪽을 사용도 못해보겠다는게 함정이라면 함정이지만 말이다.</p><p>그런 느낌으로 지내오다가 요즘 VM 가지고 놀다가 자체 NAT으로 돌리자니 불편한점이 너무 많고 어차피 <code>iptime</code> 공유기 안쪽에서 노는건데 ip관리는 전부 공유기한테 시키고 <code>Host</code>는 가상머신만 구동시키라는 느낌으로 브릿지 구성하면서 뻘짓들 기록으로좀 남겨본다.</p><h2 id=netplan-이란>Netplan 이란?</h2><p>레드헷진영은 아직인거 같지면 우분투진영은 <code>Netplan</code>으로 옮겨왔다. 로우레벨 영역에서 돌아가는건 똑같지만 <code>Netplan</code>은 <code>yaml</code>형식으로 네트워크 구성을 명시해두면 알아서 설정파일을 만들어서 <code>NetworkManager</code>(좀더 하드웨어쪽) 이랑 <code>Systemd-Networkd</code>(좀더 소프트웨어쪽)의 설정을 한꺼번에 처리해주는 놈이다.</p><p><img src=./netplan_design_overview.svg alt></p><p>이거 하나로 브릿지 구성, 트래픽조절, 와이파이 연결, ip 설정 변경등 다양한 작업을 할 수 있어 사람을 예전에 여기저기 폴더 돌아다니면서 네트워크 설정하던 시절로 돌아가지 못하게 만드는 흉악한 녀석이다.</p><h2 id=목표>목표</h2><p>다음과 같은 상황을 가정한다.</p><p>Host의 실제 물리적으로 존재하는 NIC는 <code>eth0</code> 하나만 존재한다.</p><p>VM의 NIC는 <code>vm0</code>, <code>vm1</code>, <code>vm2</code> 이런느낌으로 아주 많이 존재한다.</p><p>목표는 브릿지를 하나 만들어서 <code>Host</code>머신과 모든 <code>VM</code>에게 <code>Public IP</code>를 부여하는 것이다.</p><h2 id=본론>본론</h2><p>간단하다. 일반적인 <code>netplan</code>이 설치된 환경이면
<code>/etc/netplan</code> 폴더 속에 <code>eth0</code> interface가 정의된 설정파일이 있을것이다.
그 파일을 열어보면</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>network</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ethernets</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>eth0</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>dhcp4</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></code></pre></div><p>위와같이 정의가 되있을테고 그 뒤에 Bridge에 대한 정의를 해주면 된다.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>network</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ethernets</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>eth0</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>dhcp4</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>bridges</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>br0</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>dhcp4</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>            </span><span class=nt>interfaces</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;eth0&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></code></pre></div><blockquote><p>상식적으로 <code>eth0</code> 부분에 dhcp4 옵션은 꺼줘야 되지 않나? 생각하지만 호스트가 <code>br0</code>로 정의된 브릿지를 통해 네트워크를 실행하기 때문에 저 옵션은 무시되는거 같다.</p></blockquote><p>이제 <code>netplan apply</code> 해주면 설정이 적용된다.</p><p>이렇게 할 경우 Host 는 br0라는 NIC를 통해 인터넷에 접속되며 (MAC주소도 바뀌니깐 dhcp 설정 주의하자) 나머지 가상머신들은 네트워크 설정할때 <code>br0</code> 랑 접속만 시켜두면 외부랑 통신이 가능하다.</p><p>VLAN을 특별히 설정해두지 않으면 가상머신간에 소통을 할때 쓸때없이 트래픽이 <code>eth0</code>를 통해 <code>Host</code>외부까지 갔다가 다시 돌아오지 않을까? 라는 염려를 조금 하긴 했으나, 실제 실험결과 내부간 소통은 트래픽이 내부에서만 처리되는걸로 확인했다. 이부분은 조금 공부가 필요.</p><h2 id=단점>단점</h2><p>이게 실제 물리 디바이스를가지고 하면 잘된다. 안드로이드 스마트폰부터 라즈베리파이, x86서버 등등은 정말 잘된다.</p><p>근데 가상 브릿지가 물려있는 가상머신 속에서 또 브릿지를 하나 만들면 안된다. 일단 dhcp가 안되서 ip주소 할당이 안되고, 수동으로 ip할당해도 외부랑 통신은 커녕 Host와 VM 간의 통신도 안된다. KVM과 Hyper-V 두 환경 모두에서 확인한 결과고 KVM의 경우 NIC로 Virtio를 사용했다.</p><p>아마 가상 브릿지 두개이상 물리면 뭔가 문제가 생기는 모양이지만 필자의 경우 이 상황이 꼭 필요한건 아니므로 패스.</p><h2 id=단점2>단점2</h2><p>설정중에 당연하지만 네트워크가 끊긴다. SSH로 작업하는건 추천하지 않는다. 위와같이 가상머신 속 브릿지 구축처럼 알수없는 이유로 네트워크가 단절될수 있고, 이 상태에서 당황에서 리부팅하면 <code>systemd-networkd-wait-online</code>가 네트워크 연결 안됬다고 부팅을 막아버린다&mldr;&mldr;;;;</p><p>근데 또 가끔 설정 완료하고 바로는 네트워크가 안되는데 재부팅하면 되는경우가 있어서 재부팅을 안해볼수도 없다는게 함정이다.</p><blockquote><p>systemctl disable systemd-networkd-wait-online
systemctl mask systemd-networkd-wait-online</p></blockquote><p>이 두가지는 꼭 실행하고 설정에 임하도록 하자.
전자는 부팅시 자동로딩되지 않게, 후자는 dependency 관계인 놈들이 이 서비스를 호출하지 않도록 막는 명령어다.</p><h2 id=후기>후기</h2><p>네트워크는 짜증난다.</p><p>될꺼라 생각했는데 안될경우도 많고, 안될꺼 알지만 반쯤 자포자기로 해봤는데 갑자기 되는경우도 있다.</p><p>문제는 이렇게 어떻게든 한번만 성공하면, 영원히 방치다. 문제일어나기 전까지는 절대 안만지고, 문제가 일어나지도 않는다.
<del>(지금도 어떻게 Bridge에다 NAT 환경을 하나 붙여두긴 했는데 이건 진짜 어떻게 했는지도 모르겠다.)</del></p><p>그러니 성공해도 왜 성공했는지 모르며, 경험이 쌓이지 않는것 같다는게 개인적인 감상이다.</p><p>그래서 작지만 성공한 케이스에 대해 이렇게 기록을 남겨보고자 한다.</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload="renderMathInElement(document.querySelector(`.article-content`));"></script></article><aside class="widget related-contents--wrapper"><h1 class=widget-title></h1><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=https://iwanhae.github.io/p/disabling_uas_on_linux/><div class=article-image><img src=/p/disabling_uas_on_linux/5700219_2_hud52212587ef5e2c8c5bb794242b75122_10725_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy data-key=disabling_uas_on_linux data-hash="md5-r4H8r7HtiIGX0oIWzgDLPw=="></div><div class=article-details><h2 class=article-title>Odroid N2, Linux에서 UAS 비활성화</h2></div></a></article><article class=has-image><a href=https://iwanhae.github.io/p/renewing_freenom_domain/><div class=article-image><img src=/p/renewing_freenom_domain/1_hu4676b6a3ff35eaeac3cf791939cc3722_949805_250x150_fill_box_smart1_2.PNG width=250 height=150 loading=lazy data-key=renewing_freenom_domain data-hash="md5-7ZxOVLCu21fJCBAM/o/Q0w=="></div><div class=article-details><h2 class=article-title>Freenom 도메인 갱신하는법</h2></div></a></article><article class=has-image><a href=https://iwanhae.github.io/p/saga_of_wanhae_the_googler/><div class=article-image><img src=/p/saga_of_wanhae_the_googler/1_hu41572d6144ff73f80dd14306a597fd99_32390_250x150_fill_box_smart1_2.png width=250 height=150 loading=lazy data-key=saga_of_wanhae_the_googler data-hash="md5-TQ+TXrYq1o9bVX2sdT4MyA=="></div><div class=article-details><h2 class=article-title>사이버 지식 정보방 (사지방) 구글 접속기</h2></div></a></article><article class=has-image><a href=https://iwanhae.github.io/p/shellinabox/><div class=article-image><img src=/p/shellinabox/1315785_orig_hudca17843baf6397cc566da5ede5721bb_100680_250x150_fill_box_smart1_2.png width=250 height=150 loading=lazy data-key=shellinabox data-hash="md5-GOA/Kcd9fjsrqwwlgO5Q6w=="></div><div class=article-details><h2 class=article-title>ShellinaBox 웹에서 즐기는 터미널</h2></div></a></article><article class=has-image><a href=https://iwanhae.github.io/p/rc-local_systemd/><div class=article-image><img src=/p/rc-local_systemd/I0KhR2h_hu59fcb432b4a2908e7ac0916b6c71503c_118270_250x150_fill_box_smart1_2.png width=250 height=150 loading=lazy data-key=rc-local_systemd data-hash="md5-U2QLmnmnV53nS0QDqtkUzw=="></div><div class=article-details><h2 class=article-title>Systemd를 이용한 rc.local활성화 (우분투 16.10)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"wanhae"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><footer class=site-footer><section class=copyright>&copy; 2020 iWan</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=1.0.5>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script><link rel=stylesheet href=/css/highlight/light.min.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=/css/highlight/dark.min.css media="(prefers-color-scheme: dark)"></body></html>